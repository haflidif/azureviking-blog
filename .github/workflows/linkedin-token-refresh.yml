name: Refresh LinkedIn Token

on:
  # Run every 50 days (before 60-day access token expiry)
  schedule:
    - cron: '0 12 */50 * *'

  # Manual trigger
  workflow_dispatch:

permissions: {}

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Refresh LinkedIn access token
        id: refresh
        env:
          LINKEDIN_REFRESH_TOKEN: ${{ secrets.LINKEDIN_REFRESH_TOKEN }}
          LINKEDIN_CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
          LINKEDIN_CLIENT_SECRET: ${{ secrets.LINKEDIN_CLIENT_SECRET }}
        run: |
          echo "Refreshing LinkedIn access token..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            'https://www.linkedin.com/oauth/v2/accessToken' \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${LINKEDIN_REFRESH_TOKEN}" \
            -d "client_id=${LINKEDIN_CLIENT_ID}" \
            -d "client_secret=${LINKEDIN_CLIENT_SECRET}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Token refresh failed (HTTP $HTTP_CODE)"
            exit 1
          fi

          NEW_TOKEN=$(echo "$BODY" | jq -r '.access_token')
          NEW_REFRESH=$(echo "$BODY" | jq -r '.refresh_token // empty')
          EXPIRES_IN=$(echo "$BODY" | jq -r '.expires_in')

          # Mask tokens in logs before any output
          echo "::add-mask::$NEW_TOKEN"
          if [ -n "$NEW_REFRESH" ]; then
            echo "::add-mask::$NEW_REFRESH"
          fi

          echo "Token refreshed. Expires in $((EXPIRES_IN / 86400)) days."

          echo "new_token=$NEW_TOKEN" >> $GITHUB_OUTPUT
          echo "new_refresh=$NEW_REFRESH" >> $GITHUB_OUTPUT

      - name: Update access token secret
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_SECRETS }}
          NEW_TOKEN: ${{ steps.refresh.outputs.new_token }}
          NEW_REFRESH: ${{ steps.refresh.outputs.new_refresh }}
        run: |
          echo "$NEW_TOKEN" | gh secret set LINKEDIN_ACCESS_TOKEN --repo "${{ github.repository }}" > /dev/null 2>&1
          echo "✅ LINKEDIN_ACCESS_TOKEN updated."

          if [ -n "$NEW_REFRESH" ]; then
            echo "$NEW_REFRESH" | gh secret set LINKEDIN_REFRESH_TOKEN --repo "${{ github.repository }}" > /dev/null 2>&1
            echo "✅ LINKEDIN_REFRESH_TOKEN updated."
          fi
