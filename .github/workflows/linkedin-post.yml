name: Share on LinkedIn

on:
  # Auto-trigger after successful deploy
  workflow_run:
    workflows: ['Deploy to GitHub Pages']
    types: [completed]
    branches: [main]

  # Manual trigger for re-posting
  workflow_dispatch:
    inputs:
      post_slug:
        description: 'Slug of the post to share (e.g., review-pone-biometrics-offpad-biometric-fido-2-authentication-device)'
        required: true
        type: string
      custom_text:
        description: 'Custom LinkedIn post text (optional, overrides template)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  preview:
    runs-on: ubuntu-latest
    # Only run if deploy succeeded (or manual trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Generate preview
        id: preview
        env:
          DRY_RUN: 'true'
          LINKEDIN_ACCESS_TOKEN: 'unused'
          LINKEDIN_PERSON_URN: 'unused'
          SITE_URL: 'https://azureviking.com'
          POST_SLUG: ${{ github.event.inputs.post_slug || '' }}
          CUSTOM_TEXT: ${{ github.event.inputs.custom_text || '' }}
        run: |
          OUTPUT=$(node .github/scripts/linkedin-post.mjs 2>&1)
          echo "$OUTPUT"
          # Write preview to job summary so it's visible when approving
          {
            echo "## ðŸ“‹ LinkedIn Post Preview"
            echo ""
            echo '```'
            echo "$OUTPUT"
            echo '```'
            echo ""
            echo "**Review this preview, then approve the 'post' job to publish on LinkedIn.**"
          } >> "$GITHUB_STEP_SUMMARY"

  post:
    runs-on: ubuntu-latest
    needs: preview
    environment: linkedin-post

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Share on LinkedIn
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_PERSON_URN: ${{ secrets.LINKEDIN_PERSON_URN }}
          SITE_URL: 'https://azureviking.com'
          POST_SLUG: ${{ github.event.inputs.post_slug || '' }}
          CUSTOM_TEXT: ${{ github.event.inputs.custom_text || '' }}
        run: node .github/scripts/linkedin-post.mjs
