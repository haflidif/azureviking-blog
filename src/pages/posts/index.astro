---
import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';

const posts = await getCollection('posts');
const sortedPosts = posts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// Extract all unique tags
const allTags = Array.from(new Set(posts.flatMap((post) => post.data.tags || []))).sort();
---

<Layout title="Blog Posts" description="Browse all blog posts">
  <h1 class="text-4xl font-bold mb-8">Blog Posts</h1>

  {
    allTags.length > 0 && (
      <div class="mb-8">
        <h2 class="text-lg font-semibold mb-4">Filter by tag:</h2>
        <div class="flex flex-wrap gap-2">
          {allTags.map((tag) => {
            const count = posts.filter((p) => p.data.tags?.includes(tag)).length;
            return (
              <a
                href={`/posts/tag/${tag}`}
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors bg-secondary text-secondary-foreground hover:bg-secondary/80"
              >
                {tag} ({count})
              </a>
            );
          })}
        </div>
      </div>
    )
  }

  {
    sortedPosts.length === 0 ? (
      <p class="text-muted-foreground">No posts yet.</p>
    ) : (
      <div class="space-y-6">
        {sortedPosts.map((post) => (
          <article class="border border-border rounded-lg p-6 hover:shadow-md transition-shadow">
            <a href={`/posts/${post.slug}`} class="group">
              <h2 class="text-2xl font-semibold mb-2 group-hover:text-primary transition-colors">
                {post.data.title}
              </h2>
              {post.data.description && (
                <p class="text-muted-foreground mb-3">{post.data.description}</p>
              )}
              <div class="flex items-center gap-4 text-sm text-muted-foreground">
                <time datetime={post.data.pubDate.toISOString()}>
                  {post.data.pubDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
                {post.data.author && <span>by {post.data.author}</span>}
              </div>
              {post.data.tags && post.data.tags.length > 0 && (
                <div class="flex gap-2 mt-3">
                  {post.data.tags.map((tag) => (
                    <a
                      href={`/posts/tag/${tag}`}
                      class="text-xs bg-secondary text-secondary-foreground px-2 py-1 rounded hover:bg-secondary/80 transition-colors"
                      onclick={(e: Event) => e.stopPropagation()}
                    >
                      {tag}
                    </a>
                  ))}
                </div>
              )}
            </a>
          </article>
        ))}
      </div>
    )
  }

  <div class="mt-8">
    <a href="/" class="text-primary hover:underline">‚Üê Back to home</a>
  </div>
</Layout>
