---
import Layout from '@/layouts/Layout.astro';
import { render, type CollectionEntry } from 'astro:content';
import { formatDate } from '@/lib/utils/date';
import TableOfContents from '@/components/TableOfContents.svelte';
import { getPublishedPosts, getPostSlug } from '@/lib/utils/posts';
import { basePath } from '@/lib/utils/basePath';
import { getTagColor } from '@/lib/utils/tagColors';

import Breadcrumbs from '@/components/Breadcrumbs.svelte';
import SocialShare from '@/components/SocialShare.svelte';
import SeriesNavigation from '@/components/SeriesNavigation.astro';
import LanguageSelector from '@/components/LanguageSelector.svelte';
import CTABlock from '@/components/CTABlock.astro';
import Comments from '@/components/Comments.svelte';
import ReadingProgress from '@/components/ReadingProgress.svelte';
import RelatedPosts from '@/components/RelatedPosts.astro';
import ViewCounter from '@/components/ViewCounter.svelte';
import { getBlogPostingSchema, getBreadcrumbSchema } from '@/lib/schemas';
import { getReadTime } from '@/lib/utils/readTime';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  return posts.map((post: CollectionEntry<'posts'>) => ({
    params: { slug: getPostSlug(post) },
    props: post,
  }));
}

type Props = CollectionEntry<'posts'>;

const post = Astro.props as Props;
const { Content, headings } = await render(post);

const effectiveSlug = getPostSlug(post);
const readTime = getReadTime(post.body || '');

// Get sorted posts for prev/next navigation
const allPosts = (await getPublishedPosts()).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);
const currentIndex = allPosts.findIndex((p) => getPostSlug(p) === effectiveSlug);
const prevPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

const schemas = [
  getBlogPostingSchema({
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate,
    url: new URL(Astro.url.pathname, Astro.site).toString(),
    lang: post.data.lang,
    image: new URL(`/og/${effectiveSlug}.png`, Astro.site).toString(),
    tags: post.data.tags,
  }),
  getBreadcrumbSchema([
    { name: 'Blog', url: new URL('/post', Astro.site).toString() },
    { name: post.data.title, url: new URL(Astro.url.pathname, Astro.site).toString() },
  ]),
];
---

<Layout
  title={post.data.title}
  description={post.data.description}
  lang={post.data.lang}
  ogImage={`${basePath('/og/' + effectiveSlug + '.png')}`}
  schema={schemas}
>
  <ReadingProgress client:load />

  <Breadcrumbs
    items={[
      { name: 'Blog', href: basePath('/post') },
      { name: post.data.title, href: '#' },
    ]}
  />

  <div class="lg:flex lg:gap-16">
    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <div class="mb-8">
        <header class="flex flex-col gap-4">
          <div
            class="flex flex-wrap items-center gap-x-3 gap-y-2 text-xs text-muted-foreground font-bold uppercase tracking-widest"
          >
            <time datetime={post.data.pubDate.toISOString()}>
              {formatDate(post.data.pubDate)}
            </time>
            <span class="hidden sm:inline text-border">•</span>
            <div class="flex items-center gap-1.5">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-3 w-3"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {readTime}
            </div>
            <ViewCounter slug={getPostSlug(post)} client:idle />
            {
              post.data.draft && (
                <>
                  <span class="hidden sm:inline text-border">•</span>
                  <div class="flex items-center gap-1.5 text-amber-600 dark:text-amber-400 bg-amber-100 dark:bg-amber-900/30 px-2 py-1 rounded">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-3.5 w-3.5"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    Draft
                  </div>
                </>
              )
            }
            {
              post.data.tags && post.data.tags.length > 0 && (
                <>
                  <span class="hidden sm:inline text-border">•</span>
                  <div class="flex flex-wrap gap-1.5">
                    {post.data.tags.map((tag: string) => {
                      const colors = getTagColor(tag);
                      return (
                        <a
                          href={basePath(`/post/tag/${tag}`)}
                          class={`inline-flex items-center px-2.5 py-1 rounded-full text-[11px] font-bold uppercase tracking-wide border no-underline hover:opacity-80 transition-opacity ${colors.bg} ${colors.text} ${colors.border}`}
                        >
                          {tag}
                        </a>
                      );
                    })}
                  </div>
                </>
              )
            }
          </div>

          <h1 class="text-3xl font-black tracking-tight text-foreground sm:text-4xl lg:text-5xl">
            {post.data.title}
          </h1>

          <p class="text-lg text-muted-foreground italic border-l-2 border-primary/20 pl-4 py-1">
            {post.data.description}
          </p>
        </header>

        {
          post.data.series && (
            <SeriesNavigation seriesId={post.data.series.id} currentPostId={post.id} />
          )
        }

        {
          post.data.translatedPosts && (
            <LanguageSelector client:load translations={post.data.translatedPosts} />
          )
        }
      </div>

      <article class="prose max-w-none mt-12 mb-16">
        <Content />
      </article>

      {post.data.showCTA !== false && <CTABlock />}

      <SocialShare client:load title={post.data.title} urlPath={Astro.url.pathname} />

      {post.data.showComments !== false && <Comments client:load />}

      {/* Previous / Next post navigation */}
      {
        (prevPost || nextPost) && (
          <nav class="mt-12 mb-8 border-t border-border pt-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
            {prevPost ? (
              <a
                href={basePath(`/post/${getPostSlug(prevPost)}`)}
                class="group flex flex-col gap-1 p-4 rounded-lg border border-border hover:border-primary/30 hover:bg-accent/50 transition-all no-underline"
              >
                <span class="text-[10px] font-bold uppercase tracking-widest text-muted-foreground">
                  ← Previous
                </span>
                <span class="text-sm font-bold text-foreground group-hover:text-primary transition-colors line-clamp-1">
                  {prevPost.data.title}
                </span>
              </a>
            ) : (
              <div />
            )}
            {nextPost ? (
              <a
                href={basePath(`/post/${getPostSlug(nextPost)}`)}
                class="group flex flex-col gap-1 p-4 rounded-lg border border-border hover:border-primary/30 hover:bg-accent/50 transition-all no-underline text-right"
              >
                <span class="text-[10px] font-bold uppercase tracking-widest text-muted-foreground">
                  Next →
                </span>
                <span class="text-sm font-bold text-foreground group-hover:text-primary transition-colors line-clamp-1">
                  {nextPost.data.title}
                </span>
              </a>
            ) : (
              <div />
            )}
          </nav>
        )
      }

      <RelatedPosts currentPost={post} />
    </div>

    <!-- Sidebar (TOC) -->
    <div class="hidden lg:block w-64 flex-shrink-0">
      <TableOfContents client:load {headings} />
    </div>
  </div>
</Layout>
