---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import ContentGrid from '@/components/ContentGrid.svelte';
import FeaturedCarousel from '@/components/FeaturedCarousel.svelte';
import BioCard from '@/components/BioCard.astro';
import ThemeBanner from '@/components/ThemeBanner.svelte';
import { getReadTime } from '@/lib/utils/readTime';
import { getPublishedPosts, getPostSlug } from '@/lib/utils/posts';
import { SITE } from '@/config';
import { basePath } from '@/lib/utils/basePath';
import { formatDate } from '@/lib/utils/date';
import { postToUnified, appearanceToUnified } from '@/lib/types/content';
import bannerLight from '@/site-assets/azure_viking_banner_light_mode.png';
import bannerDark from '@/site-assets/azure_viking_banner_dark_mode.png';

const posts = (await getPublishedPosts()).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const featuredPosts = posts.filter((post) => post.data.featured).slice(0, SITE.featuredPostsCount);

const carouselPosts = featuredPosts.map((post) => ({
  title: post.data.title,
  description: post.data.description,
  slug: getPostSlug(post),
  coverImage: post.data.coverImage,
  tags: post.data.tags,
  pubDate: formatDate(post.data.pubDate),
  readTime: getReadTime(post.body || ''),
}));

const appearances = await getCollection('appearances');

// Build unified content feed
const allContent = [
  ...posts.map((p) => postToUnified(p, SITE.base)),
  ...appearances.map((a) => appearanceToUnified(a, SITE.base)),
].sort((a, b) => b.date.valueOf() - a.date.valueOf());

// Serialize for client component
const contentItems = allContent.map(({ date: _date, ...rest }) => rest);

const lightBannerImg = await getImage({ src: bannerLight, format: 'png' });
const darkBannerImg = await getImage({ src: bannerDark, format: 'png' });
---

<Layout>
  <ThemeBanner lightSrc={lightBannerImg.src} darkSrc={darkBannerImg.src} client:load />

  <!-- 1. Hero: Featured Carousel + Bio Card -->
  <section class="mb-10 lg:mb-14">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_240px] gap-4 lg:gap-5">
      <div class="order-1 lg:order-2">
        <BioCard />
      </div>
      <div class="order-2 lg:order-1 min-h-[250px]">
        {
          carouselPosts.length > 0 ? (
            <FeaturedCarousel posts={carouselPosts} client:load />
          ) : (
            <div class="aspect-[16/10] rounded-2xl bg-secondary/30 border border-border/50 flex items-center justify-center">
              <p class="text-muted-foreground">No featured posts yet</p>
            </div>
          )
        }
      </div>
    </div>
  </section>

  <div class="flex flex-col gap-10 lg:gap-14">
    <!-- 2. Unified Content Feed -->
    <section>
      <div class="flex items-baseline justify-between mb-6 sm:mb-8">
        <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-muted-foreground">
          Latest Content
        </h2>
        <div class="h-px flex-1 mx-4 sm:mx-8 bg-border opacity-70"></div>
        <a
          href={basePath('/content')}
          class="px-2 py-0.5 rounded-md text-xs font-bold uppercase tracking-widest hover:bg-accent hover:text-primary transition-all no-underline"
          >View All</a
        >
      </div>
      <ContentGrid items={contentItems} client:load />
    </section>
  </div>
</Layout>
